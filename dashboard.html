<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <title>Dashboard - Resultados del Juego</title>

    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        table, th, td { border: 1px solid #ccc; }
        th, td { padding: 10px; text-align: left; }
        #map { height: 400px; margin-top: 20px; }
        h2 { margin-top: 40px; }
    </style>
</head>

<body>

<h1>Dashboard de Resultados</h1>

<h2>Tabla de respuestas</h2>
<table id="tablaResultados">
    <thead>
        <tr>
            <th>ID</th>
            <th>Alias</th>
            <th>Punto Seleccionado</th>
            <th>Latitud</th>
            <th>Longitud</th>
            <th>Fecha</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<h2>Mapa de localizaciones</h2>
<div id="map"></div>

<script>
    // ========================
    // CONFIGURACIÃ“N SUPABASE
    // ========================

    const SUPABASE_URL = "https://czppmgrvffpuoiaoduxx.supabase.co";
    const SUPABASE_KEY = "sb_publishable_Qf5GqauZh78nEiS950bVew_FzihB41o";

    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // ========================
    // CARGAR RESULTADOS
    // ========================
    async function cargarResultados() {
        const { data, error } = await supabase
            .from("respuestas_juego")
            .select("*")
            .order("id", { ascending: true });

        if (error) {
            console.error("Error cargando datos:", error);
            return;
        }

        renderTabla(data);
        renderMapa(data);
    }

    // ========================
    // RENDER TABLA
    // ========================
    function renderTabla(datos) {
        const tbody = document.querySelector("#tablaResultados tbody");
        tbody.innerHTML = "";

        datos.forEach(item => {
            const fila = `
                <tr>
                    <td>${item.id}</td>
                    <td>${item.alias || "-"}</td>
                    <td>${item.punto || "-"}</td>
                    <td>${item.lat || "-"}</td>
                    <td>${item.lng || "-"}</td>
                    <td>${item.created_at}</td>
                </tr>
            `;
            tbody.insertAdjacentHTML("beforeend", fila);
        });
    }

    // ========================
    // RENDER MAPA
    // ========================
    let mapa;
    function renderMapa(datos) {
        if (!mapa) {
            mapa = L.map("map").setView([4.5, -74.1], 7);
            L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
                attribution: "&copy; OpenStreetMap contributors"
            }).addTo(mapa);
        }

        datos.forEach(p => {
            if (p.lat && p.lng) {
                L.marker([p.lat, p.lng])
                    .addTo(mapa)
                    .bindPopup(`<b>${p.alias}</b><br>Punto: ${p.punto}`);
            }
        });
    }

    // Ejecutar carga
    cargarResultados();
</script>

</body>
</html>
