<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>¡Localiza Bogotá!</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Supabase UMD -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>

    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        #map { height: 500px; width: 100%; margin-top: 15px; border: 1px solid #aaa; }
        select, button { padding: 5px; }
    </style>
</head>
<body>

<h1>¡Localiza Bogotá!</h1>
Selecciona un sitio y haz clic en el mapa para marcar tu respuesta.
<br><br>

<label for="sitioSelect">Sitio a ubicar:</label>
<select id="sitioSelect">
    <option value="">Cargando sitios...</option>
</select>

<div id="map"></div>

<br>
<button id="btnEnviar">Enviar respuesta</button>

<script>
    /* ---------------------------
       CONFIGURACIÓN SUPABASE
    ----------------------------*/
    const SUPABASE_URL = "https://czppmgrvffpuoiaoduxx.supabase.co";
    const SUPABASE_KEY = "sb_publishable_Qf5GqauZh78nEiS950bVew_FzihB41o";

    const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);


    /* ---------------------------
       INICIALIZAR MAPA
    ----------------------------*/
    const map = L.map('map').setView([4.65, -74.1], 12);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19
    }).addTo(map);

    let marcador = null;
    let latSeleccionada = null;
    let lonSeleccionada = null;


    /* ---------------------------
       CAPTURAR CLIC EN EL MAPA
    ----------------------------*/
    map.on("click", function (e) {
        latSeleccionada = e.latlng.lat;
        lonSeleccionada = e.latlng.lng;

        if (marcador) map.removeLayer(marcador);

        marcador = L.marker([latSeleccionada, lonSeleccionada]).addTo(map);
    });


    /* ---------------------------
       CARGAR LISTA DE SITIOS
    ----------------------------*/
    async function cargarSitios() {
        const { data, error } = await client
            .from("sitios_oficiales")
            .select("*");

        const select = document.getElementById("sitioSelect");

        if (error) {
            select.innerHTML = `<option>Error cargando sitios</option>`;
            console.error(error);
            return;
        }

        select.innerHTML = "";

        data.forEach(s => {
            const option = document.createElement("option");
            option.value = s.sitio_clave;
            option.textContent = `${s.sitio_clave} – ${s.sitio_nombre}`;
            select.appendChild(option);
        });
    }

    cargarSitios();


    /* ---------------------------
       ENVIAR RESPUESTA
    ----------------------------*/
    document.getElementById("btnEnviar").addEventListener("click", async function () {

        const sitio = document.getElementById("sitioSelect").value;

        if (!sitio) {
            alert("Selecciona un sitio.");
            return;
        }
        if (!latSeleccionada || !lonSeleccionada) {
            alert("Haz clic en el mapa para seleccionar la ubicación.");
            return;
        }

        const { data, error } = await client
            .from("respuestas_juego")
            .insert({
                sitio_clave: sitio,
                lat: latSeleccionada,
                lon: lonSeleccionada
            });

        if (error) {
            alert("Error al guardar la respuesta.");
            console.error(error);
        } else {
            alert("¡Respuesta registrada correctamente!");
        }
    });

</script>

</body>
</html>
